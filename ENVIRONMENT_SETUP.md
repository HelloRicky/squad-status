# Environment Variable Setup

This document explains how to configure the Supabase credentials for the squad-status dashboard.

## üîê Security Model

**Credentials are NO LONGER hardcoded** in the source code. They are injected at build time via environment variables.

- **Build time**: The `build.sh` script generates `config.js` from environment variables
- **Git**: `config.js` is excluded from version control (`.gitignore`)
- **Deployment**: Environment variables are configured in Cloudflare Pages dashboard and GitHub Secrets

## üìã Required Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `SUPABASE_URL` | Your Supabase project URL | `https://xxxxx.supabase.co` |
| `SUPABASE_ANON_KEY` | Supabase anonymous/public key | `eyJhbGci...` |

> ‚ö†Ô∏è **Note**: The anon key is designed to be public and embedded in client-side code. Security is enforced via Row Level Security (RLS) policies. See [SECURITY.md](./SECURITY.md) for details.

---

## üöÄ Setup Instructions

### Option 1: Cloudflare Pages Dashboard (Recommended)

This is the recommended approach for production deployments.

1. **Log in to Cloudflare Dashboard**
   - Go to https://dash.cloudflare.com
   - Navigate to **Pages** ‚Üí **squad-status**

2. **Configure Build Settings**
   - Go to **Settings** ‚Üí **Environment variables**
   - Click **Add variable** for production and preview environments

3. **Add Variables**
   
   For **Production**:
   ```
   Variable name: SUPABASE_URL
   Value: https://your-project.supabase.co
   
   Variable name: SUPABASE_ANON_KEY
   Value: your-supabase-anon-key-here
   ```

   For **Preview** (dev branch):
   ```
   (Same values as production - we use the same Supabase instance)
   ```

4. **Configure Build Command**
   - Go to **Settings** ‚Üí **Builds & deployments**
   - Set **Build command**: `./build.sh`
   - Set **Build output directory**: `.` (current directory)

5. **Trigger Rebuild**
   - Go to **Deployments** tab
   - Click **Retry deployment** on the latest deployment
   - Or push a new commit to trigger automatic deployment

### Option 2: GitHub Actions (Current Setup)

The current GitHub Actions workflow is configured to build and deploy automatically.

1. **Add GitHub Secrets**
   - Go to your GitHub repository
   - Navigate to **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions**
   - Click **New repository secret**

2. **Add These Secrets**:
   ```
   Name: SUPABASE_URL
   Value: https://your-project.supabase.co
   
   Name: SUPABASE_ANON_KEY
   Value: your-supabase-anon-key-here
   
   Name: CLOUDFLARE_API_TOKEN
   Value: (your existing Cloudflare API token)
   
   Name: DISCORD_WEBHOOK
   Value: (your existing Discord webhook URL)
   ```

3. **How It Works**
   - On push to `master` or `dev` branch
   - GitHub Actions runs `build.sh` with environment variables
   - Generates `config.js` with credentials
   - Deploys to Cloudflare Pages via Wrangler

---

## üíª Local Development

For local development, you have two options:

### Option A: Use Placeholders (Quick Start)

Just run the build script without environment variables:

```bash
./build.sh
```

This generates a `config.js` with placeholder values. Replace them manually in the generated file for testing.

### Option B: Use Environment Variables (Recommended)

1. **Create a `.env` file** (already in `.gitignore`):
   ```bash
   SUPABASE_URL=https://your-project.supabase.co
   SUPABASE_ANON_KEY=your-supabase-anon-key-here
   ```

2. **Load environment variables and build**:
   ```bash
   # Load env vars
   export $(cat .env | xargs)
   
   # Run build
   ./build.sh
   
   # Serve locally
   python3 -m http.server 8000
   # OR
   npx serve .
   ```

3. **Open browser**:
   ```
   http://localhost:8000
   ```

---

## üîç Verification

After setup, verify that credentials are properly injected:

1. **Check generated config.js**:
   ```bash
   cat config.js
   ```
   
   Should output:
   ```javascript
   // Auto-generated configuration file
   // DO NOT EDIT - This file is generated by build.sh
   // Generated at: 2026-02-14 21:45:00 UTC

   const SUPABASE_URL = 'https://your-project.supabase.co';
   const SUPABASE_ANON_KEY = 'your-supabase-anon-key-here';
   ```

2. **Check browser console**:
   - Open the dashboard in your browser
   - Open DevTools (F12) ‚Üí Console
   - Verify no errors about missing `SUPABASE_URL` or `SUPABASE_ANON_KEY`

3. **Verify data loads**:
   - Dashboard should show agent status cards
   - Timeline should load activity history
   - No "Loading..." state stuck

---

## üõ†Ô∏è Troubleshooting

### Error: "SUPABASE_URL is not defined"

**Cause**: `config.js` was not loaded or is missing.

**Fix**:
1. Check that `config.js` exists in the same directory as `index.html`
2. Run `./build.sh` to generate it
3. Clear browser cache and refresh

### Error: "Failed to fetch" or network errors

**Cause**: Invalid credentials in `config.js`.

**Fix**:
1. Verify the values in `config.js` match your Supabase project
2. Check Cloudflare Pages environment variables are set correctly
3. Re-run the build: `./build.sh`

### Deployment builds but shows placeholders

**Cause**: Environment variables not set in Cloudflare Pages or GitHub Actions.

**Fix**:
1. **For Cloudflare Pages**: Add variables in dashboard (see Option 1 above)
2. **For GitHub Actions**: Add secrets in repository settings (see Option 2 above)
3. Trigger a new deployment

### Local development shows "your-anon-key-here"

**Cause**: Build script ran without environment variables.

**Fix**:
```bash
# Set environment variables
export SUPABASE_URL="https://your-project.supabase.co"
export SUPABASE_ANON_KEY="your-supabase-anon-key-here"

# Re-run build
./build.sh
```

---

## üìö Related Documentation

- [SECURITY.md](./SECURITY.md) - Security model and RLS policies
- [DEPLOYMENT.md](./DEPLOYMENT.md) - Deployment workflows
- [README.md](./README.md) - Project overview

---

## ‚úÖ Migration Checklist

If you're migrating from hardcoded credentials:

- [ ] Run `./build.sh` to generate `config.js`
- [ ] Add `config.js` to `.gitignore` (already done)
- [ ] Configure environment variables in Cloudflare Pages dashboard
- [ ] Add GitHub Secrets for Actions workflow
- [ ] Test local development with environment variables
- [ ] Deploy and verify production works
- [ ] Remove any old hardcoded credentials from documentation

---

**Last Updated**: 2026-02-14  
**Maintained By**: Linus (Backend Engineer)
