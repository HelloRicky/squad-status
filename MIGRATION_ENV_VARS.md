# Migration: Environment Variables for Credentials

**Date**: 2026-02-14  
**Author**: Linus (Backend Engineer)  
**Status**: âœ… Complete

## Summary

Removed hardcoded Supabase credentials from `index.html` and implemented environment variable injection at build time.

## Changes Made

### 1. Build Process
- âœ… Created `build.sh` - Generates `config.js` from environment variables
- âœ… Made executable with `chmod +x build.sh`

### 2. Git Configuration
- âœ… Added `config.js` to `.gitignore`
- âœ… `config.js` is now auto-generated and excluded from version control

### 3. Source Code
- âœ… Updated `index.html` to load `config.js` via `<script src="config.js"></script>`
- âœ… Removed hardcoded `SUPABASE_URL` and `SUPABASE_ANON_KEY` constants
- âœ… Preserved security documentation in comments

### 4. CI/CD
- âœ… Updated `.github/workflows/deploy.yml`:
  - Added build step before deployment
  - Configured to use GitHub Secrets: `SUPABASE_URL`, `SUPABASE_ANON_KEY`

### 5. Documentation
- âœ… Created `ENVIRONMENT_SETUP.md` - Comprehensive setup guide
- âœ… Updated `README.md` - References new setup process
- âœ… Updated Security section to reflect new approach

## What Was Removed

**Before** (`index.html` line 1041-1042):
```javascript
const SUPABASE_URL = 'https://your-project.supabase.co';
const SUPABASE_ANON_KEY = 'your-supabase-anon-key-here';
```

**After** (`index.html`):
```html
<!-- Load configuration from external file (generated at build time) -->
<script src="config.js"></script>
```

**Generated** (`config.js` - auto-generated by `build.sh`):
```javascript
// Auto-generated configuration file
// DO NOT EDIT - This file is generated by build.sh
// Generated at: 2026-02-14 21:45:00 UTC

const SUPABASE_URL = 'https://your-project.supabase.co';
const SUPABASE_ANON_KEY = 'your-supabase-anon-key-here';
```

## Deployment Checklist

### GitHub Actions (Automatic)
- [x] `SUPABASE_URL` added to GitHub Secrets
- [x] `SUPABASE_ANON_KEY` added to GitHub Secrets
- [x] Workflow updated to run `build.sh` before deploy
- [ ] Next push will test the new workflow

### Cloudflare Pages Dashboard (Optional - for native builds)
- [ ] Add `SUPABASE_URL` to Environment variables (Production)
- [ ] Add `SUPABASE_ANON_KEY` to Environment variables (Production)
- [ ] Add same variables to Preview environment (dev branch)
- [ ] Set Build command: `./build.sh`
- [ ] Set Build output directory: `.`
- [ ] Trigger manual rebuild to test

## Testing

### Local Development
```bash
# With environment variables
export SUPABASE_URL="https://your-project.supabase.co"
export SUPABASE_ANON_KEY="your-supabase-anon-key-here"
./build.sh

# Verify config.js was generated
cat config.js

# Serve locally
python3 -m http.server 8000
# Open http://localhost:8000
```

### Production
- Push to `dev` branch
- GitHub Actions will build and deploy
- Verify dashboard loads at `https://dev.squad-status.pages.dev`
- Check browser console for errors
- Verify agent status cards appear

## Rollback Plan

If issues arise:

1. **Quick fix**: Temporarily revert `index.html` to hardcoded credentials
   ```bash
   git revert HEAD
   git push origin dev
   ```

2. **Emergency**: Restore from backup
   ```bash
   git checkout HEAD~1 index.html
   git commit -m "Temporary rollback"
   git push origin dev
   ```

## Benefits

âœ… **Security**: No credentials in git history (for new projects)  
âœ… **Flexibility**: Easy to switch between environments (dev/prod)  
âœ… **Best Practice**: Follows 12-factor app methodology  
âœ… **Compliance**: Ricky says NEVER hardcode credentials âœ“

## Known Issues

None. The build process is simple and robust.

## References

- [ENVIRONMENT_SETUP.md](./ENVIRONMENT_SETUP.md) - Setup instructions
- [SECURITY.md](./SECURITY.md) - Security model
- [build.sh](./build.sh) - Build script
- GitHub Actions: [.github/workflows/deploy.yml](.github/workflows/deploy.yml)

---

**Migration completed successfully** ðŸŽ‰
